name: Publish Artifact Definitions

on:
  push:
    branches:
      - main
    paths:
      - 'artifact-definitions/**'
      - '.github/workflows/publish-artifact-definitions.yml'

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      MASSDRIVER_API_KEY: ${{ secrets.MASSDRIVER_API_KEY }}
      MASSDRIVER_ORG_ID: ${{ vars.MASSDRIVER_ORG_ID }}
      MASSDRIVER_URL: ${{ vars.MASSDRIVER_URL || 'https://api.massdriver.cloud' }}
    steps:
      - uses: actions/checkout@v4
      - name: Install Massdriver CLI
        uses: massdriver-cloud/actions/setup@v5
      - name: Publish All Artifact Definitions
        run: |
          for dir in artifact-definitions/*/; do
            name=$(basename "$dir")
            echo "Publishing artifact definition $name..."
            mass definition publish "$dir/massdriver.yaml"
          done
