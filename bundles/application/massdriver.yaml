name: application
description: "Example application bundle (edit in ./bundles/application/massdriver.yaml)"
source_url: https://github.com/YOUR_ORG/massdriver-catalog/tree/main/bundles/application
version: 0.0.0

params:
  required:
    - image
    - replicas
    - domain_name
  examples:
    - __name: Development (edit in ./bundles/application/massdriver.yaml)
      image: "nginx:latest"
      replicas: 1
      port: 8080
      domain_name: "dev.example.com"
    - __name: Production (edit in ./bundles/application/massdriver.yaml)
      image: "nginx:stable"
      replicas: 3
      port: 8080
      domain_name: "app.example.com"
  properties:
    image:
      type: string
      title: Container Image
      description: Container image to deploy
      default: "nginx:latest"
    replicas:
      type: integer
      title: Replicas
      description: Number of replicas to deploy
      default: 2
      minimum: 1
      maximum: 10
    port:
      type: integer
      title: Port
      description: Port the application listens on
      default: 8080
      minimum: 1
      maximum: 65535
    domain_name:
      type: string
      title: Domain Name
      description: Domain name for the application
      default: "app.example.com"
      pattern: ^[a-z0-9][a-z0-9.-]*[a-z0-9]$
    database_policy:
      type: string
      title: Database Access Policy
      description: Access policy to apply for database access
      $md.enum:
        connection: database
        options: .policies
        value: .name
    bucket_policy:
      type: string
      title: Bucket Access Policy
      description: Access policy to apply for bucket access
      $md.enum:
        connection: bucket
        options: .policies
        value: .name

connections:
  required:
    - network
    - database
    - zone
  properties:
    network:
      $ref: network
    database:
      $ref: postgres
      # We expect a postgres artifact, but this application specifically needs postgres
      # 16, so we validate that before deploy.
      properties:
        version:
          const: "16"
    bucket:
      $ref: bucket
    zone:
      $ref: landing-zone

artifacts:
  required:
    - application
  properties:
    application:
      $ref: application

steps:
  - path: src
    provisioner: opentofu:1.10

ui:
  ui:order:
    - image
    - replicas
    - port
    - domain_name
    - database_policy
    - bucket_policy
    - "*"
